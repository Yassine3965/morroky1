<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Merchant Screen Fix</title>
    <script type="module">
        // Mock the dependencies
        const mockState = {
            getState: () => ({
                selectedMerchantId: 'test-merchant-123'
            }),
            setState: (newState) => {
                console.log('State updated:', newState);
            }
        };

        const mockMerchantService = {
            getMerchantById: async (id) => {
                console.log('Fetching merchant:', id);
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                return {
                    id: id,
                    name: 'Ù…ØªØ¬Ø± Ø§Ø®ØªØ¨Ø§Ø±',
                    logo_url: 'https://placehold.co/400x400?text=Test+Store',
                    phone: '0612345678',
                    location: {
                        city: 'Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡',
                        district: 'Ø§Ù„Ø­ÙŠ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠØ©',
                        market: 'Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²'
                    }
                };
            },
            getProductsByMerchantId: async (id) => {
                console.log('Fetching products for merchant:', id);
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                return [
                    {
                        id: 'prod-1',
                        name: 'Ù…Ù†ØªØ¬ Ø§Ø®ØªØ¨Ø§Ø± 1',
                        price: '100',
                        image_url: 'https://placehold.co/600x600?text=Product+1'
                    },
                    {
                        id: 'prod-2',
                        name: 'Ù…Ù†ØªØ¬ Ø§Ø®ØªØ¨Ø§Ø± 2',
                        price: '200',
                        image_url: 'https://placehold.co/600x600?text=Product+2'
                    }
                ];
            }
        };

        const mockLocationManager = {
            formatAddress: (location) => {
                return `${location.city || ''} ${location.district || ''} ${location.market || ''}`.trim();
            }
        };

        // Import the actual MerchantScreen class (this would be replaced with actual import in real app)
        class MerchantScreen {
            constructor(props = {}) {
                this.state = {
                    merchant: null,
                    products: [],
                    loading: true
                };
                this.container = null;
            }

            setState(newState) {
                this.state = { ...this.state, ...newState };
                if (this.container) {
                    this.container.innerHTML = this.template();
                    this.setupEventListeners();
                }
            }

            setupEventListeners() {
                document.getElementById('btn-home')?.addEventListener('click', () => {
                    mockState.setState({ screen: 'world' });
                });
            }

            async onRendered() {
                const s = mockState.getState();
                if (s.selectedMerchantId) {
                    await this.fetchMerchant(s.selectedMerchantId);
                } else {
                    this.setState({ loading: false });
                }

                this.setupEventListeners();
            }

            async fetchMerchant(id) {
                try {
                    const [merchant, products] = await Promise.all([
                        mockMerchantService.getMerchantById(id),
                        mockMerchantService.getProductsByMerchantId(id)
                    ]);

                    this.setState({
                        merchant,
                        products: products || [],
                        loading: false
                    });
                } catch (err) {
                    console.error('Failed to fetch merchant details', err);
                    this.setState({ loading: false });
                }
            }

            template() {
                if (this.state.loading) {
                    return `
                        <div class="min-h-screen flex items-center justify-center bg-gray-50 rtl">
                            <div class="text-center">
                                <div class="inline-block w-8 h-8 border-4 border-morroky-red border-t-transparent rounded-full animate-spin mb-4"></div>
                                <p class="text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±...</p>
                            </div>
                        </div>
                    `;
                }

                const m = this.state.merchant;
                const products = this.state.products;

                if (!m) {
                    return `
                        <div class="min-h-screen flex items-center justify-center bg-gray-50 rtl">
                            <div class="text-center p-12 glass-morphism rounded-3xl max-w-md">
                                <h2 class="text-2xl font-black text-gray-800 mb-4">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h2>
                                <button id="btn-home" class="bg-morroky-dark text-white px-8 py-3 rounded-2xl font-bold">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©</button>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="min-h-screen bg-gray-50 rtl pb-20">
                        <div class="h-64 bg-gradient-to-r from-morroky-dark to-morroky-red relative overflow-hidden">
                            <button id="btn-home" class="absolute top-6 right-6 bg-white/20 hover:bg-white/30 backdrop-blur-md text-white px-4 py-2 rounded-xl text-sm font-bold transition-all z-20">
                                â† Ø§Ù„Ø¹ÙˆØ¯Ø©
                            </button>
                        </div>

                        <div class="max-w-6xl mx-auto px-6 -mt-32 relative z-10">
                            <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100">
                                <h1 class="text-4xl font-black text-gray-900 mb-2">${m.name}</h1>
                                <p class="text-gray-500 font-medium text-lg">
                                    ğŸ“ ${mockLocationManager.formatAddress(m.location || {})}
                                </p>

                                <h3 class="text-2xl font-black text-gray-900 mb-4 mt-8">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (${products.length})</h3>
                                <div id="products-list">
                                    ${products.map(p => `
                                        <div class="bg-gray-50 rounded-lg p-4 mb-2">
                                            ${p.name} - ${p.price} DH
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Test the MerchantScreen
        document.addEventListener('DOMContentLoaded', async () => {
            const appContainer = document.getElementById('app');
            const merchantScreen = new MerchantScreen();
            merchantScreen.container = appContainer;

            console.log('Starting test...');
            console.log('Initial state - loading should be true');

            // Render initial template
            appContainer.innerHTML = merchantScreen.template();

            console.log('Calling onRendered - this should fetch data and update state...');

            // Call onRendered which should trigger the data fetch
            await merchantScreen.onRendered();

            console.log('Test completed - check if the UI updated from loading to showing merchant data');
        });
    </script>
    <style>
        .rtl {
            direction: rtl;
        }
        .bg-morroky-dark {
            background-color: #2d1b69;
        }
        .bg-morroky-red {
            background-color: #e63946;
        }
        .text-morroky-blue {
            color: #1d3557;
        }
        .from-morroky-dark {
            --tw-gradient-from: #2d1b69;
        }
        .to-morroky-red {
            --tw-gradient-to: #e63946;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="console-output" style="margin: 20px; padding: 10px; border: 1px solid #ccc; max-height: 200px; overflow: auto;">
        <h3>Console Output:</h3>
        <pre id="console-log"></pre>
    </div>

    <script>
        // Redirect console.log to the page
        const originalConsoleLog = console.log;
        const consoleLogElement = document.getElementById('console-log');

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return String(arg);
            }).join(' ');
            consoleLogElement.textContent += message + '\n';
            consoleLogElement.scrollTop = consoleLogElement.scrollHeight;
        };
    </script>
</body>
</html>
