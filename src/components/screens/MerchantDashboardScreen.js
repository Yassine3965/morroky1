\nimport MerchantService from \'../../services/merchant.service\';\nimport StorageService from \'../../services/storage.service\';\nimport LocationManager from \'../../managers/location-manager\';\nimport state from \'../../managers/state-manager\';\nimport AuthService from \'../../services/auth.service.js\';\n\nexport default class MerchantDashboardScreen {\n    constructor(container, { merchantId }) {\n        this.container = container;\n        this.merchantId = merchantId;\n        this.state = {\n            merchant: null,\n            products: [],\n            loading: true,\n            error: null,\n            isUploading: false,\n            uploadMessage: \'\'\n        };\n        this.mount();\n    }\n\n    mount() {\n        if (!this.merchantId) {\n            this._setState({ loading: false, error: \'No merchant ID provided.\' });\n            return;\n        }\n        this.render();\n        this.fetchData();\n    }\n\n    _setState(partialState) {\n        this.state = { ...this.state, ...partialState };\n        this.render();\n    }\n\n    render() {\n        this.container.innerHTML = this.template();\n        this.bindEvents();\n    }\n\n    bindEvents() {\n        // Use event delegation for all interactions\n        this.container.addEventListener(\'click\', async (e) => {\n            const target = e.target;\n\n            // Back link\n            if (target.id === \'back-link\') {\n                state.setState({ screen: \'gateway\' });\n                window.location.hash = \'#\';\n            }\n            // Logout\n            if (target.id === \'btn-logout\') {\n                await AuthService.logout();\n                state.setState({ screen: \'gateway\' });\n                window.location.hash = \'#\';\n            }\n\n            // Open product picker modal for landing page\n            if (target.id === \'create-landing-page-btn\') {\n                this.openLpModal();\n            }\n\n            // Close landing page modal\n            if (target.id === \'close-lp-modal\' || e.target.closest(\'#landing-page-modal\') && !e.target.closest(\'.modal-content\')) {\n                this.closeLpModal();\n            }\n\n            // Select product for landing page\n            const lpProductItem = target.closest(\'.lp-product-item\');\n            if (lpProductItem) {\n                const productId = lpProductItem.dataset.productId;\n                this.closeLpModal();\n                state.setState({ screen: \'landing-page-editor\', productId, merchantId: this.merchantId });\n            }\n\n            // Delete product\n            const deleteBtn = target.closest(\'.delete-product-btn\');\n            if (deleteBtn) {\n                const productId = deleteBtn.dataset.productId;\n                this.handleDeleteProduct(productId);\n            }\n        });\n\n        this.container.addEventListener(\'submit\', async (e) => {\n            // Add new product\n            if (e.target.id === \'add-product-form\') {\n                e.preventDefault();\n                this.handleAddProduct(e.target);\n            }\n        });\n\n        this.container.addEventListener(\'change\', async (e) => {\n            const target = e.target;\n\n            // Uploads\n            if (target.id === \'logo-input\') this.handleFileUpload(target.files[0], \'logo\');\n            if (target.id === \'background-input\') this.handleFileUpload(target.files[0], \'background\');\n            if (target.classList.contains(\'product-image-input\')) {\n                const productId = target.dataset.productId;\n                this.handleFileUpload(target.files[0], \'product\', productId);\n            }\n        });\n    }\n\n    async fetchData() {\n        this._setState({ loading: true });\n        try {\n            // RLS will ensure only the owner or an admin can fetch this data.\n            const [merchant, products] = await Promise.all([\n                MerchantService.getMerchantById(this.merchantId),\n                MerchantService.getProductsByMerchantId(this.merchantId)\n            ]);\n\n            if (!merchant) {\n                throw new Error(\'Merchant not found or you do not have permission to view it.\');\n            }\n\n            this._setState({ merchant, products, loading: false, error: null });\n        } catch (err) {\n            console.error(\'Failed to fetch merchant data:\', err);\n            this._setState({ loading: false, error: \'Access Denied. You may not have permission to view this page.\' });\n        }\n    }\n\n    async handleAddProduct(form) {\n        const name = form.querySelector(\'#prod-name\').value;\n        const price = form.querySelector(\'#prod-price\').value;\n        const imageInput = form.querySelector(\'#prod-image\');\n        const file = imageInput.files[0];\n\n        if (!name || !price) {\n            state.showToast(\'Please fill in product name and price.\', \'error\');\n            return;\n        }\n\n        this._setUploading(true, \'Adding product...\');\n        try {\n            let imageUrl = null;\n            if (file) {\n                imageUrl = await StorageService.uploadImage(file, `products/${this.merchantId}`);\n            }\n            await MerchantService.addProduct({ merchant_id: this.merchantId, name, price: parseFloat(price), image_url: imageUrl });\n            state.showToast(\'Product added successfully!\', \'success\');\n            form.reset();\n            await this.fetchData();\n        } catch (err) {\n            state.showToast(`Error: ${err.message}`, \'error\');\n        } finally {\n            this._setUploading(false);\n        }\n    }\n\n    handleDeleteProduct(productId) {\n        state.showConfirm({\n            title: \'Delete Product\',\n            message: \'Are you sure you want to delete this product? This cannot be undone.\',\n            onConfirm: async () => {\n                this._setUploading(true, \'Deleting product...\');\n                try {\n                    await MerchantService.deleteProduct(productId);\n                    state.showToast(\'Product deleted.\', \'success\');\n                    await this.fetchData(); // Refresh list\n                } catch (err) {\n                    state.showToast(`Error: ${err.message}`, \'error\');\n                } finally {\n                    this._setUploading(false);\n                }\n            }\n        });\n    }\n\n    async handleFileUpload(file, type, entityId = null) {\n        if (!file) return;\n\n        this._setUploading(true, `Uploading ${type}...\`);\n        try {\n            const path = type === \'product\' ? `products/${this.merchantId}` : type;\n            const url = await StorageService.uploadImage(file, path);\n\n            switch (type) {\n                case \'logo\':\n                    await MerchantService.updateMerchantLogo(this.merchantId, url);\n                    break;\n                case \'background\':\n                    await MerchantService.updateMerchantBackground(this.merchantId, url);\n                    break;\n                case \'product\':\n                    await MerchantService.updateProductImage(entityId, url);\n                    break;\n            }\n            state.showToast(`${type} updated successfully!`, \'success\');\n            await this.fetchData();\n        } catch (err) {\n            state.showToast(`Upload failed: ${err.message}`, \'error\');\n        } finally {\n            this._setUploading(false);\n        }\n    }\n\n    _setUploading(isUploading, uploadMessage = \'\') {\n        this._setState({ isUploading, uploadMessage });\n    }\n    \n    openLpModal() {\n        const modal = this.container.querySelector(\'#landing-page-modal\');\n        if(modal) modal.classList.remove(\'hidden\');\n    }\n\n    closeLpModal() {\n        const modal = this.container.querySelector(\'#landing-page-modal\');\n        if(modal) modal.classList.add(\'hidden\');\n    }\n\n    template() {\n        if (this.state.loading) return `<div class=\"p-12 text-center text-gray-500\">Loading dashboard...</div>`;\n        \n        if (this.state.error) {\n             return `\n                <div class=\"min-h-screen flex items-center justify-center bg-gray-50 rtl\">\n                    <div class=\"text-center p-12 bg-white rounded-3xl shadow-xl max-w-md\">\n                        <h2 class=\"text-2xl font-black text-red-600 mb-4\">Access Denied</h2>\n                        <p class=\"text-gray-600 mb-6\">You do not have permission to view this page. Please log in with the correct account.</p>\n                        <button id=\"btn-logout\" class=\"bg-morroky-dark text-white px-8 py-3 rounded-2xl font-bold\">Return and Log In</button>\n                    </div>\n                </div>\n            `;\n        }\n\n        const { merchant: m, products } = this.state;\n\n        return `\n            <div class=\"min-h-screen bg-gray-50 p-6 rtl relative\">\n                ${this.state.isUploading ? `\n                    <div class=\"fixed inset-0 bg-black/50 z-50 flex items-center justify-center\">\n                        <div class=\"bg-white p-6 rounded-2xl flex flex-col items-center\">\n                            <div class=\"animate-spin rounded-full h-10 w-10 border-b-2 border-morroky-blue mb-4\"></div>\n                            <p class=\"font-bold\">${this.state.uploadMessage}</p>\n                        </div>\n                    </div>\n                ` : \'\'}\n\n                <div id=\"landing-page-modal\" class=\"fixed inset-0 bg-black/60 z-[101] hidden flex items-center justify-center p-4\">\n                    <div class=\"modal-content bg-white w-full max-w-2xl rounded-3xl shadow-2xl animate-slide-up\">\n                       <div class=\"p-8\">\n                            <div class=\"flex justify-between items-center mb-6\">\n                                <h2 class=\"text-2xl font-bold text-gray-900\">Choose a Product for the Landing Page</h2>\n                                <button id=\"close-lp-modal\" class=\"text-gray-400 hover:text-morroky-red text-2xl\">&times;</button>\n                            </div>\n                            <div class=\"max-h-[60vh] overflow-y-auto space-y-3\">\n                                ${products.length > 0 ? products.map(p => `\n                                    <div class=\"lp-product-item flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200 hover:border-morroky-blue hover:bg-blue-50 transition cursor-pointer\" data-product-id=\"${p.id}\">\n                                        <div class=\"flex items-center gap-4\">\n                                            <img src=\"${p.image_url || \'https://placehold.co/100x100\'}\" class=\"w-16 h-16 rounded-lg object-cover\" />\n                                            <div>\n                                                <h3 class=\"font-bold text-gray-800\">${p.name}</h3>\n                                                <p class=\"text-sm text-morroky-green font-bold\">${p.price} DH</p>\n                                            </div>\n                                        </div>\n                                        <button class=\"text-blue-600 font-bold text-sm\">Customize</button>\n                                    </div>\n                                `).join(\'\') : \'<p class=\"text-center text-gray-500 py-8\">You must add products first.</p>\'}\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"max-w-4xl mx-auto\">\n                     <header class=\"mb-8 flex justify-between items-center\">\n                        <div>\n                            <h1 class=\"text-3xl font-black text-gray-900\">Manage: ${m.name}</h1>\n                        </div>\n                        <a href=\"javascript:void(0)\" id=\"back-link\" class=\"text-blue-600 font-bold hover:underline\">Return to Main</a>\n                    </header>\n\n                    <!-- Main Grid -->\n                    <div class=\"grid grid-cols-1 md:grid-cols-3 gap-8\">\n                        <!-- Left Column: Branding -->\n                        <div class=\"bg-white p-6 rounded-3xl shadow-sm border border-gray-100 h-fit\">\n                            <h2 class=\"text-xl font-bold mb-4\">Branding</h2>\n                            <div class=\"flex flex-col items-center\">\n                                <div class=\"w-32 h-32 rounded-full bg-gray-100 overflow-hidden mb-4 border-4 border-white shadow-lg relative group\">\n                                    <img src=\"${m.logo_url || \'https://placehold.co/200x200\'}\" class=\"w-full h-full object-cover\" />\n                                    <label class=\"absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer text-white font-bold text-xs\">\n                                        Change\n                                        <input type=\"file\" id=\"logo-input\" accept=\"image/*\" class=\"hidden\" />\n                                    </label>\n                                </div>\n                                <div class=\"w-full h-32 rounded-xl bg-white overflow-hidden mb-4 border-4 border-white shadow-lg relative group\">\n                                     <div class=\"absolute inset-0 opacity-10\" style=\"background-image: url(\'${m.background_url || \'\'}\'); background-size: cover; background-position: center;\"></div>\n                                     <label class=\"absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer text-white font-bold text-sm z-20\">\n                                        Change Background\n                                        <input type=\"file\" id=\"background-input\" accept=\"image/*\" class=\"hidden\" />\n                                    </label>\n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Right Column: Products -->\n                        <div class=\"md:col-span-2 space-y-8\">\n                            <div class=\"bg-white p-6 rounded-3xl shadow-sm border border-gray-100\">\n                                <h2 class=\"text-xl font-bold mb-4\">Add New Product</h2>\n                                <form id=\"add-product-form\" class=\"space-y-4\">\n                                    <!-- Form fields -->\n                                     <input type=\"text\" id=\"prod-name\" class=\"w-full p-3 bg-gray-50 rounded-xl border\" placeholder=\"Product Name\" required />\n                                     <input type=\"number\" id=\"prod-price\" class=\"w-full p-3 bg-gray-50 rounded-xl border\" placeholder=\"Price (DH)\" required />\n                                     <input type=\"file\" id=\"prod-image\" accept=\"image/*\" class=\"w-full p-2 bg-gray-50 rounded-xl border text-sm\" />\n                                    <button type=\"submit\" class=\"w-full bg-morroky-blue text-white font-bold py-3 rounded-xl\">+ Add Product</button>\n                                </form>\n                            </div>\n\n                            <div>\n                                <h2 class=\"text-xl font-bold mb-4\">My Products (${products.length})</h2>\n                                <div class=\"grid grid-cols-2 sm:grid-cols-3 gap-4\">\n                                    ${products.map(p => `\n                                        <div class=\"bg-white rounded-2xl overflow-hidden border group relative\">\n                                            <img src=\"${p.image_url || \'https://placehold.co/300x300\'}\" class=\"h-32 w-full object-cover\" />\n                                             <div class=\"p-3\">\n                                                <h3 class=\"font-bold text-sm truncate\">${p.name}</h3>\n                                                <p class=\"text-morroky-green font-bold text-sm\">${p.price} DH</p>\n                                                <button data-product-id=\"${p.id}\" class=\"delete-product-btn absolute top-2 left-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100\">üóëÔ∏è</button>\n                                                <label class=\"absolute top-2 right-2 bg-blue-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer\">\n                                                    üì∑\n                                                    <input type=\"file\" data-product-id=\"${p.id}\" class=\"product-image-input hidden\" accept=\"image/*\" />\n                                                </label>\n                                            </div>\n                                        </div>\n                                    `).join(\'\')}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }\n}\n