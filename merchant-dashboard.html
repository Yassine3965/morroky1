<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORROKY - لوحة التاجر</title>
    <link rel="stylesheet" href="src/styles/main.css">
</head>
<body>
    <div id="merchant-dashboard"></div>
    <script type="module">
        import { createApp } from './src/app.js';
        import { supabase } from './src/services/supabase.js';

        // Single source of truth for auth redirect logic
        const authStateCallback = (event, user) => {
            if (event === 'SIGNED_IN' && user) {
                // User signed in, load the app
                createApp('#merchant-dashboard', 'merchant-dashboard');
            } else if (event === 'SIGNED_OUT' || !user) {
                // User signed out or no session, redirect to home
                window.location.href = '/';
            }
        };

        // Listen for auth state changes
        supabase.auth.onAuthStateChange(authStateCallback);

        // Check initial auth state
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session?.user) {
                // User is already authenticated, load the app
                createApp('#merchant-dashboard', 'merchant-dashboard');
            } else {
                // No session, redirect to home
                window.location.href = '/';
            }
        });
    </script>
</body>
</html>
